<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ntudioka Admin ¬∑ Community Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(135deg, #0b0c10 0%, #1a1f2e 100%); color: #e0e0e0; min-height: 100vh; }

    .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }

    .public-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 5%; background: rgba(10, 15, 20, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid #00ffff33; position: sticky; top: 0; z-index: 50; }

    .logo { font-size: 2rem; font-weight: 700; background: linear-gradient(45deg, #00ffff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .btn-outline { background: transparent; border: 1px solid #00ffff; color: #00ffff; padding: 8px 25px; border-radius: 40px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .btn-outline:hover { background: #00ffff22; }

    #admin-login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; z-index: 1000; }

    .login-card { width: 360px; padding: 40px; background: rgba(20, 30, 50, 0.9); border: 1px solid #00ffff; border-radius: 30px; box-shadow: 0 0 50px #00ffff33; }

    .login-card h2 { text-align: center; margin-bottom: 30px; color: #00ffff; }

    .login-card input { width: 100%; padding: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 40px; color: white; font-size: 1rem; }

    .login-card button { width: 100%; padding: 15px; background: linear-gradient(45deg, #00ffff, #ff00ff); border: none; border-radius: 40px; font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }

    .login-card button:hover { transform: scale(1.05); box-shadow: 0 0 20px #00ffff; }

    .reset-link { text-align: center; margin-top: 15px; font-size: 0.9rem; }
    .reset-link a { color: #00ffff; text-decoration: none; cursor: pointer; }

    #admin-dashboard { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0c14; z-index: 2000; overflow-y: auto; }

    .dashboard-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: #10131f; border-bottom: 1px solid #00ffff33; }

    .dashboard-header h1 { font-size: 2rem; background: linear-gradient(45deg, #00ffff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .dashboard-nav { display: flex; gap: 20px; background: #1a1e2f; padding: 15px 30px; flex-wrap: wrap; }

    .dashboard-nav button { background: transparent; border: none; color: #aaa; font-size: 1.1rem; padding: 10px 20px; border-radius: 40px; cursor: pointer; transition: 0.3s; }

    .dashboard-nav button.active { background: #00ffff22; color: #00ffff; border: 1px solid #00ffff; }

    .dashboard-content { padding: 30px; }

    .card { background: rgba(255,255,255,0.03); border: 1px solid #2a2e45; border-radius: 30px; padding: 25px; margin-bottom: 30px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #00ffff; }

    .form-control { width: 100%; padding: 15px; background: #1e2335; border: 1px solid #3a4055; border-radius: 40px; color: white; }

    textarea.form-control { border-radius: 20px; resize: vertical; }

    .btn { background: linear-gradient(45deg, #00ffff, #ff00ff); border: none; padding: 12px 30px; border-radius: 40px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-right: 10px; }
    .btn:hover { transform: scale(1.05); }

    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #1a1f30; border-radius: 40px; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }

    .status-badge { background: #00ffaa22; color: #00ffaa; padding: 4px 12px; border-radius: 40px; font-size: 0.8rem; }

    .hidden { display: none !important; }

    .error-message { color: #ff4d4d; margin-top: 10px; }
    .success-message { color: #00ffaa; margin-top: 10px; }

  </style>
</head>

<body>
  <div id="public-site">
    <header class="public-header">
      <div class="logo">Ntudioka Admin</div>
      <div><button onclick="showLogin()" class="btn-outline">Admin Login</button></div>
    </header>

    <main style="padding: 60px 20px; text-align: center;">
      <h1 style="color: #00ffff; font-size: 3rem;">‚ö° Community Dashboard</h1>
      <p style="margin-top: 20px; font-size: 1.2rem; color: #aaa;">Login to post and manage community events.</p>
    </main>
  </div>

  <div id="admin-login-overlay">
    <div class="login-card">
      <h2><i class="fas fa-lock"></i> Admin Access</h2>
      <input type="text" id="login-username" placeholder="Username" value="Admin">
      <input type="password" id="login-password" placeholder="Password">
      <button onclick="attemptLogin()">Enter</button>
      <div id="login-error" class="error-message"></div>
      <div class="reset-link">
        <a onclick="resetPassword()">üîë Reset password to default (admin123)</a>
      </div>
    </div>
  </div>

  <div id="admin-dashboard">
    <div class="dashboard-header">
      <h1>‚ö° Ntudioka Control Center</h1>
      <div><button onclick="logout()" class="btn-outline">Logout</button></div>
    </div>
    <button id="nav-comments" onclick="switchTab('comments')">üí¨ Comments</button>
    <button id="nav-goodwill" onclick="switchTab('goodwill')">üíå Goodwill</button>
    <button id="nav-background" onclick="switchTab('background')">üé® Background</button>

    <div class="dashboard-nav">
      <button id="nav-events" class="active" onclick="switchTab('events')">üìå Events</button>
      <button id="nav-live" onclick="switchTab('live')">üî¥ Live Broadcast</button>
      <button id="nav-settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>

    <div class="dashboard-content">

      <!-- EVENTS TAB -->
      <div id="tab-events">

        <div class="card">
          <h2 style="color:#00ffff; margin-bottom:20px;">‚ûï Post New Event</h2>

          <div class="form-group">
            <label>Event Title</label>
            <input type="text" id="event-title" class="form-control" placeholder="e.g. Youth Meeting">
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="event-desc" class="form-control" rows="4" placeholder="Event details..."></textarea>
          </div>

          <div class="form-group">
            <label>Date</label>
            <input type="date" id="event-date" class="form-control">
          </div>

          <div class="form-group">
            <label>Location</label>
            <input type="text" id="event-location" class="form-control" placeholder="e.g. Ntudioka Town Hall">
          </div>

          <div class="form-group">
            <label>Image URL (Optional)</label>
            <input type="text" id="event-image" class="form-control" placeholder="https://example.com/image.jpg">
          </div>

          <button onclick="postEvent()" class="btn">Publish Event</button>
          <div id="event-status" style="margin-top:15px;"></div>
        </div>

        <div class="card">
          <h2 style="color:#00ffff; margin-bottom:20px;">üìö Posted Events</h2>
          <div id="events-list">Loading events...</div>
        </div>

      </div>

      <!-- LIVE TAB -->
      <div id="tab-live" class="hidden">
        <div class="card">
          <h2 style="color:#00ffff; margin-bottom:20px;">üî¥ Update Live Broadcast</h2>

          <div class="form-group">
            <label>Live Broadcast Title</label>
            <input type="text" id="live-title" class="form-control" placeholder="e.g. Ntudioka Youth Live">
          </div>

          <div class="form-group">
            <label>YouTube Live Link</label>
            <input type="text" id="live-link" class="form-control" placeholder="https://www.youtube.com/watch?v=XXXX or channel live link">
          </div>

          <button onclick="updateLive()" class="btn">Save Live Broadcast</button>
          <div id="live-status" style="margin-top:15px;"></div>
        </div>
      </div>
 <div id="tab-comments" class="hidden">
  <div class="card">
    <h2 style="color:#00ffff; margin-bottom:20px;">üí¨ Event Comments</h2>
    <div id="comments-list">Loading comments...</div>
  </div>
</div>

<div id="tab-goodwill" class="hidden">
  <div class="card">
    <h2 style="color:#00ffff; margin-bottom:20px;">üíå Goodwill Messages</h2>
    <div id="goodwill-list">Loading goodwill messages...</div>
  </div>
</div>

<div id="tab-background" class="hidden">
  <div class="card">
    <h2 style="color:#00ffff; margin-bottom:20px;">üé® Update Website Background</h2>

    <div class="form-group">
      <label>Background Image URL</label>
      <input type="text" id="bg-url" class="form-control" placeholder="https://example.com/bg.jpg">
    </div>

    <button onclick="updateBackground()" class="btn">Save Background</button>
    <div id="bg-status" style="margin-top:15px;"></div>
  </div>
</div>

<button class="btn-outline" onclick="pinThisEvent('${ev.eventId}')">üìå Pin</button>


      <!-- SETTINGS TAB -->
      <div id="tab-settings" class="hidden">
        <div class="card">
          <h2 style="color:#00ffff; margin-bottom:20px;">üîê Change Admin Password</h2>

          <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="current-password" class="form-control">
          </div>

          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="new-password" class="form-control">
          </div>

          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirm-password" class="form-control">
          </div>

          <button onclick="changePassword()" class="btn">Update Password</button>
          <div id="password-message" style="margin-top:15px;"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // üî• Replace with your deployed Web App EXEC URL
    const API_URL = "https://script.google.com/macros/s/AKfycbxue8SJHofWQVSoGpnqqeGupH6RK4RPA7qpyPIRcqzBPKDeQLNWAMFhHisUd8c3LHqQig/exec";

    let data = { adminPassword: "admin123" };

    function loadData() {
      const stored = localStorage.getItem("ntudiokaAdmin");
      if (stored) {
        try { data = JSON.parse(stored); } catch (e) {}
      }
      if (!data.adminPassword) data.adminPassword = "admin123";
    }

    function saveData() {
      localStorage.setItem("ntudiokaAdmin", JSON.stringify(data));
    }

    loadData();

    function showLogin() {
      document.getElementById("admin-login-overlay").style.display = "flex";
    }

    function attemptLogin() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();

      if (username.toLowerCase() === "admin" && password === data.adminPassword) {
        document.getElementById("admin-login-overlay").style.display = "none";
        document.getElementById("public-site").style.display = "none";
        document.getElementById("admin-dashboard").style.display = "block";
        document.getElementById("login-error").innerText = "";

        loadEventsList();
        loadLiveBroadcastData();

      } else {
        document.getElementById("login-error").innerText = "Invalid credentials";
      }
    }

    function resetPassword() {
      if (confirm("Reset admin password to default (admin123)?")) {
        data.adminPassword = "admin123";
        saveData();
        document.getElementById("login-error").innerHTML =
          "<span style='color:#00ffaa;'>‚úÖ Password reset to admin123</span>";
      }
    }

    function logout() {
      document.getElementById("admin-dashboard").style.display = "none";
      document.getElementById("public-site").style.display = "block";
    }

    function switchTab(tab) {
      document.getElementById("nav-events").classList.remove("active");
      document.getElementById("nav-live").classList.remove("active");
      document.getElementById("nav-settings").classList.remove("active");

      document.getElementById("tab-events").classList.add("hidden");
      document.getElementById("tab-live").classList.add("hidden");
      document.getElementById("tab-settings").classList.add("hidden");

      if (tab === "events") {
        document.getElementById("nav-events").classList.add("active");
        document.getElementById("tab-events").classList.remove("hidden");
        loadEventsList();
      }

      if (tab === "live") {
        document.getElementById("nav-live").classList.add("active");
        document.getElementById("tab-live").classList.remove("hidden");
        loadLiveBroadcastData();
      }

      if (tab === "settings") {
        document.getElementById("nav-settings").classList.add("active");
        document.getElementById("tab-settings").classList.remove("hidden");
      }
      if (tab === "comments") {
  document.getElementById("nav-comments").classList.add("active");
  document.getElementById("tab-comments").classList.remove("hidden");
  loadAllComments();
}

if (tab === "goodwill") {
  document.getElementById("nav-goodwill").classList.add("active");
  document.getElementById("tab-goodwill").classList.remove("hidden");
  loadGoodwillMessages();
}

if (tab === "background") {
  document.getElementById("nav-background").classList.add("active");
  document.getElementById("tab-background").classList.remove("hidden");
}

    }

    async function postEvent() {
      const title = document.getElementById("event-title").value.trim();
      const description = document.getElementById("event-desc").value.trim();
      const date = document.getElementById("event-date").value;
      const location = document.getElementById("event-location").value.trim();
      const imageUrl = document.getElementById("event-image").value.trim();
      const status = document.getElementById("event-status");

      if (!title || !description) {
        status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Title and Description required</span>";
        return;
      }

      status.innerHTML = "<span style='color:#ffaa00;'>‚è≥ Posting event...</span>";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "addEvent",
            title,
            description,
            date,
            location,
            imageUrl
          })
        });

        const data = await res.json();

        if (data.success) {
          status.innerHTML = "<span style='color:#00ffaa;'>‚úÖ Event posted successfully!</span>";

          document.getElementById("event-title").value = "";
          document.getElementById("event-desc").value = "";
          document.getElementById("event-date").value = "";
          document.getElementById("event-location").value = "";
          document.getElementById("event-image").value = "";

          loadEventsList();
        } else {
          status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå " + data.message + "</span>";
        }
      } catch (err) {
        status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Failed to post event</span>";
      }
    }

    async function loadEventsList() {
      const listDiv = document.getElementById("events-list");
      listDiv.innerHTML = "<p style='color:#aaa;'>Loading...</p>";

      try {
        const res = await fetch(API_URL + "?action=getEvents");
        const data = await res.json();

        if (!data.success) {
          listDiv.innerHTML = "<p style='color:#ff4d4d;'>‚ùå " + data.message + "</p>";
          return;
        }

        const events = data.events || [];

        if (events.length === 0) {
          listDiv.innerHTML = "<p style='color:#aaa;'>No events posted yet.</p>";
          return;
        }

        listDiv.innerHTML = "";

        events.forEach(ev => {
          const row = document.createElement("div");
          row.className = "item-row";
          row.innerHTML = `
            <div>
              <strong>${ev.title}</strong><br>
              <span style="color:#aaa;">üìÖ ${ev.date || "TBA"} ¬∑ üìç ${ev.location || "Not specified"}</span>
              <span class="status-badge">LIVE</span>
            </div>
            <div>
              <button class="btn-outline" onclick="deleteEvent('${ev.eventId}')">Delete</button>
            </div>
          `;
          listDiv.appendChild(row);
        });

      } catch (err) {
        listDiv.innerHTML = "<p style='color:#ff4d4d;'>‚ùå Failed to load events</p>";
      }
    }

    async function deleteEvent(eventId) {
      if (!confirm("Delete this event?")) return;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "deleteEvent",
            eventId: eventId
          })
        });

        const data = await res.json();

        if (data.success) {
          loadEventsList();
        } else {
          alert("Delete failed: " + data.message);
        }
      } catch (err) {
        alert("Delete failed.");
      }
    }

    async function loadLiveBroadcastData() {
      try {
        const res = await fetch(API_URL + "?action=getLiveBroadcast");
        const data = await res.json();

        if (data.success) {
          document.getElementById("live-title").value = data.title || "";
          document.getElementById("live-link").value = data.link || "";
        }
      } catch (err) {
        console.log("Failed to load live broadcast");
      }
    }

    async function updateLive() {
      const title = document.getElementById("live-title").value.trim();
      const link = document.getElementById("live-link").value.trim();
      const status = document.getElementById("live-status");

      if (!link || !link.includes("youtube.com")) {
        status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Enter a valid YouTube link</span>";
        return;
      }

      status.innerHTML = "<span style='color:#ffaa00;'>‚è≥ Saving...</span>";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "updateLiveBroadcast",
            title: title,
            link: link
          })
        });

        const data = await res.json();

        if (data.success) {
          status.innerHTML = "<span style='color:#00ffaa;'>‚úÖ Live broadcast updated!</span>";
        } else {
          status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå " + data.message + "</span>";
        }

      } catch (err) {
        status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Failed to update live broadcast</span>";
      }
    }

    function changePassword() {
      const current = document.getElementById("current-password").value.trim();
      const newPass = document.getElementById("new-password").value.trim();
      const confirmPass = document.getElementById("confirm-password").value.trim();
      const msgDiv = document.getElementById("password-message");

      if (current !== data.adminPassword) {
        msgDiv.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Current password incorrect</span>";
        return;
      }

      if (newPass.length < 5) {
        msgDiv.innerHTML = "<span style='color:#ff4d4d;'>‚ùå New password too short</span>";
        return;
      }

      if (newPass !== confirmPass) {
        msgDiv.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Passwords do not match</span>";
        return;
      }

      data.adminPassword = newPass;
      saveData();

      msgDiv.innerHTML = "<span style='color:#00ffaa;'>‚úÖ Password updated</span>";

      document.getElementById("current-password").value = "";
      document.getElementById("new-password").value = "";
      document.getElementById("confirm-password").value = "";
    }

    window.showLogin = showLogin;
    window.attemptLogin = attemptLogin;
    window.resetPassword = resetPassword;
    window.logout = logout;
    window.switchTab = switchTab;
    window.postEvent = postEvent;
    window.deleteEvent = deleteEvent;
    window.updateLive = updateLive;
    window.changePassword = changePassword;

    document.getElementById("admin-dashboard").style.display = "none";

    async function pinThisEvent(eventId) {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "pinEvent",
        eventId: eventId
      })
    });

    const data = await res.json();

    if (data.success) {
      alert("Event pinned successfully!");
      loadEventsList();
    } else {
      alert("Pin failed: " + data.message);
    }
  } catch (err) {
    alert("Pin failed.");
  }
}

async function loadAllComments() {
  const listDiv = document.getElementById("comments-list");
  listDiv.innerHTML = "Loading...";

  try {
    const res = await fetch(API_URL + "?action=getAllEventComments");
    const data = await res.json();

    if (!data.success) {
      listDiv.innerHTML = "‚ùå " + data.message;
      return;
    }

    const comments = data.comments || [];

    if (comments.length === 0) {
      listDiv.innerHTML = "<p style='color:#aaa;'>No comments yet.</p>";
      return;
    }

    listDiv.innerHTML = "";

    comments.forEach(c => {
      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
        <div>
          <strong>${c.name}</strong> (${c.village}, ${c.kindred})<br>
          <span style="color:#aaa;">Event ID: ${c.eventId}</span><br>
          <span style="color:#00ffff;">"${c.comment}"</span>
        </div>
        <div>
          <button class="btn-outline" onclick="deleteComment('${c.commentId}')">Delete</button>
        </div>
      `;
      listDiv.appendChild(row);
    });

  } catch (err) {
    listDiv.innerHTML = "‚ùå Failed to load comments.";
  }
}

async function deleteComment(commentId) {
  if (!confirm("Delete this comment?")) return;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "deleteEventComment",
        commentId: commentId
      })
    });

    const data = await res.json();

    if (data.success) {
      loadAllComments();
    } else {
      alert("Delete failed: " + data.message);
    }
  } catch (err) {
    alert("Delete failed.");
  }
}

async function loadGoodwillMessages() {
  const listDiv = document.getElementById("goodwill-list");
  listDiv.innerHTML = "Loading...";

  try {
    const res = await fetch(API_URL + "?action=getGoodwillMessages");
    const data = await res.json();

    if (!data.success) {
      listDiv.innerHTML = "‚ùå " + data.message;
      return;
    }

    const msgs = data.messages || [];

    if (msgs.length === 0) {
      listDiv.innerHTML = "<p style='color:#aaa;'>No goodwill messages yet.</p>";
      return;
    }

    listDiv.innerHTML = "";

    msgs.forEach(m => {
      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
        <div>
          <strong>${m.name}</strong> (${m.village}, ${m.kindred})<br>
          <span style="color:#00ffff;">"${m.message}"</span>
        </div>
        <div>
          <button class="btn-outline" onclick="deleteGoodwill('${m.messageId}')">Delete</button>
        </div>
      `;
      listDiv.appendChild(row);
    });

  } catch (err) {
    listDiv.innerHTML = "‚ùå Failed to load goodwill messages.";
  }
}

async function deleteGoodwill(messageId) {
  if (!confirm("Delete this goodwill message?")) return;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "deleteGoodwillMessage",
        messageId: messageId
      })
    });

    const data = await res.json();

    if (data.success) {
      loadGoodwillMessages();
    } else {
      alert("Delete failed: " + data.message);
    }
  } catch (err) {
    alert("Delete failed.");
  }
}

async function updateBackground() {
  const bgUrl = document.getElementById("bg-url").value.trim();
  const status = document.getElementById("bg-status");

  if (!bgUrl) {
    status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Background URL required</span>";
    return;
  }

  status.innerHTML = "<span style='color:#ffaa00;'>‚è≥ Updating background...</span>";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "updateBackground",
        backgroundImage: bgUrl
      })
    });

    const data = await res.json();

    if (data.success) {
      status.innerHTML = "<span style='color:#00ffaa;'>‚úÖ Background updated!</span>";
    } else {
      status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå " + data.message + "</span>";
    }
  } catch (err) {
    status.innerHTML = "<span style='color:#ff4d4d;'>‚ùå Failed to update background</span>";
  }
}

  </script>
</body>
</html>
