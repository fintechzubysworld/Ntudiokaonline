<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ntudioka Community ¬∑ Events</title>

  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(145deg, #f9f3e8 0%, #ffe9ce 100%);
      color: #2d2d2d;
      min-height: 100vh;
    }

    .header {
      background: rgba(255, 215, 0, 0.9);
      backdrop-filter: blur(8px);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(45deg, #d64b4b, #ffa600);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo i { -webkit-text-fill-color: #ffa600; margin-right: 6px; }

    .admin-link {
      background: #2d2d2d;
      color: #ffd966;
      padding: 10px 20px;
      border-radius: 40px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: 0.2s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .admin-link:hover { background: #1e1e1e; color: white; }

    .hero {
      text-align: center;
      padding: 40px 20px;
      background: url('https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1000&auto=format') center/cover;
      background-color: rgba(255, 215, 0, 0.7);
      background-blend-mode: overlay;
      color: #1e1e1e;
    }

    .hero h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
      margin-bottom: 10px;
    }

    .hero p {
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255,255,240,0.6);
      padding: 12px 20px;
      border-radius: 60px;
      backdrop-filter: blur(3px);
    }

    .search-bar {
      display: flex;
      justify-content: center;
      margin: 20px 15px;
    }

    .search-bar input {
      width: 100%;
      max-width: 450px;
      padding: 15px 25px;
      border: none;
      border-radius: 60px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
      font-size: 1rem;
      border: 2px solid transparent;
      transition: 0.2s;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #ffa600;
      box-shadow: 0 10px 25px rgba(255,166,0,0.2);
    }

    .feed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      padding: 20px 20px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .event-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 35px;
      padding: 25px 20px;
      box-shadow: 0 20px 30px rgba(0,0,0,0.1), 0 0 0 2px rgba(255,215,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }

    .event-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 25px 35px rgba(255,166,0,0.25), 0 0 0 3px #ffc107;
    }

    .event-title {
      font-size: 1.6rem;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .event-meta {
      font-size: 0.95rem;
      font-weight: 700;
      color: #b45f06;
      background: #ffecb3;
      display: inline-block;
      padding: 6px 15px;
      border-radius: 40px;
      margin-bottom: 12px;
    }

    .event-desc {
      font-size: 1rem;
      color: #3a3a3a;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .event-image {
      width: 100%;
      border-radius: 25px;
      margin-top: 10px;
      border: 2px solid rgba(255, 166, 0, 0.3);
    }

    .comment-box {
      margin-top: 18px;
      background: rgba(255,255,255,0.65);
      padding: 15px;
      border-radius: 25px;
      border: 1px solid rgba(255,166,0,0.3);
    }

    .comment-box input, .comment-box textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 15px;
      border: none;
      font-size: 0.95rem;
    }

    .comment-box textarea {
      resize: vertical;
    }

    .btn-submit {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 20px;
      background: #ffa600;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-submit:hover {
      background: #ff9500;
    }

    .status-msg {
      margin-top: 10px;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 50px;
      background: rgba(255,255,200,0.6);
      border-radius: 80px;
      font-size: 1.4rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,215,0,0.3);
      border-radius: 50%;
      border-top-color: #ffa600;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .footer {
      text-align: center;
      padding: 30px;
      color: #5a5a5a;
      font-weight: 600;
    }

    .footer i { color: #ff6b6b; }

    .live-box {
      margin-top: 25px;
      background: rgba(255,255,255,0.75);
      padding: 18px;
      border-radius: 30px;
      max-width: 750px;
      margin-left: auto;
      margin-right: auto;
      border: 2px solid rgba(255,166,0,0.3);
    }

    .live-box iframe {
      width: 100%;
      height: 320px;
      border: none;
      border-radius: 20px;
      margin-top: 12px;
    }

    .live-btn {
      display: inline-block;
      margin-top: 12px;
      background: #d64b4b;
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-weight: 700;
      text-decoration: none;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="logo"><i class="fas fa-users"></i> Ntudioka</div>
    <a href="ntuonline.html" class="admin-link" target="_blank"><i class="fas fa-crown"></i> Admin</a>
  </header>

  <section class="hero">
    <h1>üåç Ntu around the globe</h1>
    <p>Real people, real stories, real voices, real culture.</p>

    <div class="live-box">
      <h2 id="liveTitle" style="font-size:1.4rem; font-weight:800;">üî¥ Live Broadcast</h2>
      <p style="margin-top:8px; font-weight:700;">Join the live broadcast when it is active.</p>

      <iframe id="liveStreamFrame"
        src=""
        allow="autoplay; encrypted-media"
        allowfullscreen>
      </iframe>

      <a id="liveStreamLink" href="#" target="_blank" class="live-btn">
        ‚ñ∂ Watch Live
      </a>
    </div>
  </section>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="üîç Search events... (e.g. 'meeting', 'festival')">
  </div>

  <div id="feedContainer" class="feed-grid">
    <div class="empty-state">
      <div class="loading-spinner"></div>
      <p style="margin-top: 15px;">Loading events feed...</p>
    </div>
  </div>

  <footer class="footer">
    <div style="max-width:650px; margin:0 auto; background:rgba(255,255,255,0.7); padding:20px; border-radius:30px;">
      <h2 style="margin-bottom:10px;">üíå Leave a Goodwill Message</h2>

      <input id="good-name" placeholder="Full Name">
      <input id="good-village" placeholder="Village">
      <input id="good-kindred" placeholder="Kindred">
      <input id="good-email" placeholder="Email Address">
      <textarea id="good-message" placeholder="Your goodwill message..." rows="3"></textarea>

      <button class="btn-submit" onclick="submitGoodwill()">Submit Message</button>
      <div id="good-status" class="status-msg"></div>
    </div>

    <p style="margin-top:20px;">
      <i class="fas fa-heart"></i> by Ntudioka community ¬∑ 2026
    </p>
  </footer>

  <script>
    // üî• IMPORTANT: Replace this with your DEPLOYED Web App exec URL
    const API_URL = "https://script.google.com/macros/s/AKfycbxue8SJHofWQVSoGpnqqeGupH6RK4RPA7qpyPIRcqzBPKDeQLNWAMFhHisUd8c3LHqQig/exec";

    let allEvents = [];

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function youtubeToEmbed(url) {
      if (!url) return "";

      if (url.includes("embed/")) return url;

      const match = url.match(/v=([^&]+)/);
      if (match) {
        return "https://www.youtube.com/embed/" + match[1];
      }

      if (url.includes("/live")) {
        return url.replace("/live", "");
      }

      return url;
    }
    async function postData(payload) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });
  return await res.json();
}


    async function loadLiveBroadcast() {
      try {
        const res = await fetch(API_URL + "?action=getLiveBroadcast");
        const data = await res.json();

        if (data.success) {
          document.getElementById("liveTitle").innerText = "üî¥ " + (data.title || "Live Broadcast");

          const embed = youtubeToEmbed(data.link);

          document.getElementById("liveStreamFrame").src = embed;
          document.getElementById("liveStreamLink").href = data.link || "#";
        }
      } catch (err) {
        console.log("Live broadcast failed to load", err);
      }
    }

    async function fetchEvents() {
      const container = document.getElementById("feedContainer");

      container.innerHTML = `
        <div class="empty-state">
          <div class="loading-spinner"></div>
          <p style="margin-top: 15px;">Loading events feed...</p>
        </div>
      `;

      try {
        const res = await fetch(API_URL + "?action=getEvents");
        const data = await res.json();

        if (!data.success) {
          container.innerHTML = `<div class="empty-state">‚ùå ${data.message}</div>`;
          return;
        }

        allEvents = data.events || [];

        if (allEvents.length === 0) {
          container.innerHTML = `<div class="empty-state">‚ú® No events yet. Stay tuned!</div>`;
          return;
        }

        renderEvents();
      } catch (err) {
        container.innerHTML = `<div class="empty-state">‚ùå Failed to load events.</div>`;
      }
    }

    function renderEvents() {
      const filterText = document.getElementById("searchInput").value.toLowerCase();
      const filtered = filterText
        ? allEvents.filter(ev => ev.title.toLowerCase().includes(filterText))
        : allEvents;

      const container = document.getElementById("feedContainer");

      if (filtered.length === 0) {
        container.innerHTML = `<div class="empty-state">üîç No matching events</div>`;
        return;
      }

      container.innerHTML = filtered.map(ev => {
        return `
          <div class="event-card">
            <div class="event-title">üìå ${ev.title}</div>
            <div class="event-meta">üìÖ ${ev.date || "TBA"} ¬∑ üìç ${ev.location || "Not specified"}</div>

            <div class="event-desc">${ev.description}</div>

            ${ev.imageUrl ? `<img class="event-image" src="${ev.imageUrl}" />` : ""}

            <div class="comment-box">
              <h3 style="margin-bottom:10px;">üí¨ Comment on Event</h3>

              <input id="name-${ev.eventId}" placeholder="Full Name">
              <input id="village-${ev.eventId}" placeholder="Village">
              <input id="kindred-${ev.eventId}" placeholder="Kindred">
              <input id="email-${ev.eventId}" placeholder="Email Address">
              <textarea id="comment-${ev.eventId}" placeholder="Write your comment..." rows="3"></textarea>

              <button class="btn-submit" onclick="submitComment('${ev.eventId}')">Submit Comment</button>
              <div id="status-${ev.eventId}" class="status-msg"></div>
            </div>
            <div style="margin-top:15px; background:rgba(255,255,255,0.6); padding:12px; border-radius:20px;">
  <h3 style="margin-bottom:8px;">üòÄ React to this Event</h3>

  <input id="rname-${ev.eventId}" placeholder="Full Name">
  <input id="rvillage-${ev.eventId}" placeholder="Village">
  <input id="rkindred-${ev.eventId}" placeholder="Kindred">
  <input id="remail-${ev.eventId}" placeholder="Email Address">

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
    <button onclick="sendReaction('${ev.eventId}','like')">üëç Like</button>
    <button onclick="sendReaction('${ev.eventId}','love')">‚ù§Ô∏è Love</button>
    <button onclick="sendReaction('${ev.eventId}','haha')">üòÇ Haha</button>
    <button onclick="sendReaction('${ev.eventId}','wow')">üòÆ Wow</button>
    <button onclick="sendReaction('${ev.eventId}','sad')">üò¢ Sad</button>
    <button onclick="sendReaction('${ev.eventId}','angry')">üò° Angry</button>
  </div>

  <div id="reaction-summary-${ev.eventId}" style="margin-top:10px; font-weight:700; color:#b45f06;">
    Loading reactions...
  </div>

  <div id="reaction-status-${ev.eventId}" style="margin-top:8px; font-weight:700;"></div>
</div>

          </div>
        `;
      }).join("");
      filtered.forEach(ev => {
  loadReactionSummary(ev.eventId);
});

    }

    async function submitComment(eventId) {
      const name = document.getElementById(`name-${eventId}`).value.trim();
      const village = document.getElementById(`village-${eventId}`).value.trim();
      const kindred = document.getElementById(`kindred-${eventId}`).value.trim();
      const email = document.getElementById(`email-${eventId}`).value.trim();
      const comment = document.getElementById(`comment-${eventId}`).value.trim();
      const statusDiv = document.getElementById(`status-${eventId}`);

      if (!name || !village || !kindred || !email || !comment) {
        statusDiv.innerHTML = "‚ùå All fields are required.";
        statusDiv.style.color = "red";
        return;
      }

      if (!isValidEmail(email)) {
        statusDiv.innerHTML = "‚ùå Please enter a valid email address.";
        statusDiv.style.color = "red";
        return;
      }

      statusDiv.innerHTML = "‚è≥ Submitting comment...";
      statusDiv.style.color = "#b45f06";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "addEventComment",
            eventId: eventId,
            name,
            village,
            kindred,
            email,
            comment
          })
        });

        const data = await res.json();

        if (data.success) {
          statusDiv.innerHTML = "‚úÖ Comment submitted!";
          statusDiv.style.color = "green";
          document.getElementById(`comment-${eventId}`).value = "";
        } else {
          statusDiv.innerHTML = "‚ùå " + data.message;
          statusDiv.style.color = "red";
        }
      } catch (err) {
        statusDiv.innerHTML = "‚ùå Failed to submit comment.";
        statusDiv.style.color = "red";
      }
    }

    async function submitGoodwill() {
      const name = document.getElementById("good-name").value.trim();
      const village = document.getElementById("good-village").value.trim();
      const kindred = document.getElementById("good-kindred").value.trim();
      const email = document.getElementById("good-email").value.trim();
      const message = document.getElementById("good-message").value.trim();
      const statusDiv = document.getElementById("good-status");

      if (!name || !village || !kindred || !email || !message) {
        statusDiv.innerHTML = "‚ùå All fields are required.";
        statusDiv.style.color = "red";
        return;
      }

      if (!isValidEmail(email)) {
        statusDiv.innerHTML = "‚ùå Please enter a valid email address.";
        statusDiv.style.color = "red";
        return;
      }

      statusDiv.innerHTML = "‚è≥ Submitting goodwill message...";
      statusDiv.style.color = "#b45f06";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "addGoodwillMessage",
            name,
            village,
            kindred,
            email,
            message
          })
        });

        const data = await res.json();

        if (data.success) {
          statusDiv.innerHTML = "‚úÖ Goodwill message submitted!";
          statusDiv.style.color = "green";
          document.getElementById("good-message").value = "";
        } else {
          statusDiv.innerHTML = "‚ùå " + data.message;
          statusDiv.style.color = "red";
        }
      } catch (err) {
        statusDiv.innerHTML = "‚ùå Failed to submit message.";
        statusDiv.style.color = "red";
      }
    }
    async function loadSettings() {
  try {
    const res = await fetch(API_URL + "?action=getSettings");
    const data = await res.json();

    if (data.success) {
      if (data.backgroundImage) {
        document.body.style.background =
          `url('${data.backgroundImage}') center/cover fixed no-repeat`;
      }
    }
  } catch (err) {
    console.log("Settings load failed", err);
  }
}


    document.getElementById("searchInput").addEventListener("input", renderEvents);

   window.addEventListener("load", () => {
  loadSettings();
  loadLiveBroadcast();
  fetchEvents();
});
async function loadReactionSummary(eventId) {
  const div = document.getElementById(`reaction-summary-${eventId}`);

  try {
    const res = await fetch(API_URL + "?action=getReactionSummary&eventId=" + eventId);
    const data = await res.json();

    if (data.success) {
      const s = data.summary;
      div.innerHTML = `
        üëç ${s.like} &nbsp; ‚ù§Ô∏è ${s.love} &nbsp; üòÇ ${s.haha} &nbsp;
        üòÆ ${s.wow} &nbsp; üò¢ ${s.sad} &nbsp; üò° ${s.angry}
      `;
    } else {
      div.innerHTML = "No reactions yet.";
    }
  } catch (err) {
    div.innerHTML = "Failed to load reactions.";
  }
}

async function sendReaction(eventId, reactionType) {
  const name = document.getElementById(`rname-${eventId}`).value.trim();
  const village = document.getElementById(`rvillage-${eventId}`).value.trim();
  const kindred = document.getElementById(`rkindred-${eventId}`).value.trim();
  const email = document.getElementById(`remail-${eventId}`).value.trim();
  const statusDiv = document.getElementById(`reaction-status-${eventId}`);

  if (!name || !village || !kindred || !email) {
    statusDiv.innerHTML = "‚ùå Fill your details before reacting.";
    statusDiv.style.color = "red";
    return;
  }

  if (!isValidEmail(email)) {
    statusDiv.innerHTML = "‚ùå Enter a valid email.";
    statusDiv.style.color = "red";
    return;
  }

  statusDiv.innerHTML = "‚è≥ Sending reaction...";
  statusDiv.style.color = "#b45f06";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "addReaction",
        eventId,
        name,
        village,
        kindred,
        email,
        reactionType
      })
    });

    const data = await res.json();

    if (data.success) {
      statusDiv.innerHTML = "‚úÖ Reaction saved!";
      statusDiv.style.color = "green";
      loadReactionSummary(eventId);
    } else {
      statusDiv.innerHTML = "‚ùå " + data.message;
      statusDiv.style.color = "red";
    }

  } catch (err) {
    statusDiv.innerHTML = "‚ùå Failed to send reaction.";
    statusDiv.style.color = "red";
  }
}

  </script>
</body>
</html>
