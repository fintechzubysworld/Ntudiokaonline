<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ntudioka Admin</title>
    <!-- ... (styles same as before, keep them) ... -->
</head>
<body>
    <!-- ... (all HTML same as previous admin panel) ... -->

    <script>
        // ========== CONFIGURATION ==========
        const CLIENT_ID = '672649423935-e3g0m98jkikrp6p4e5iesd3mqs4tfpqi.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD91n0Uv-It5GUtfrXyNRXWs8o1eTWiHAo';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // ... (keep all data loading and Google Drive initialisation the same) ...

        // ========== UPDATED UPLOAD FUNCTION ==========
        async function uploadFileToDrive(file) {
            await ensureAuthenticated();
            const metadata = {
                name: file.name,
                mimeType: file.type,
                parents: ['root']
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
                body: form
            });
            const fileData = await response.json();
            const fileId = fileData.id;

            // Make file public (anyone with link can read)
            await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
                method: 'POST',
                headers: {
                    Authorization: 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role: 'reader',
                    type: 'anyone'
                })
            });

            // üî• Use the direct download link (works in <audio> tag)
            const directLink = `https://drive.google.com/uc?export=download&id=${fileId}`;

            return {
                fileId,
                directLink,          // <-- store this instead of webContentLink
                fileName: file.name
            };
        }

        // Update the uploadEpisode function to use directLink
        async function uploadEpisode() {
            const title = document.getElementById('episode-title').value.trim();
            const desc = document.getElementById('episode-desc').value.trim();
            const fileInput = document.getElementById('audio-file');
            const file = fileInput.files[0];
            if (!title || !desc || !file) {
                document.getElementById('upload-status').innerHTML = '<span style="color:#ff4d4d;">All fields required</span>';
                return;
            }
            document.getElementById('upload-status').innerHTML = '<span style="color:#00ffaa;">‚è≥ Uploading to Drive...</span>';

            try {
                const driveResult = await uploadFileToDrive(file);
                const newEpisode = {
                    id: Date.now(),
                    title,
                    desc,
                    date: new Date().toISOString().slice(0,10),
                    driveFileId: driveResult.fileId,
                    driveLink: driveResult.directLink,  // ‚úÖ store direct link
                    fileName: driveResult.fileName
                };
                data.episodes.push(newEpisode);
                saveData();
                document.getElementById('upload-status').innerHTML = '<span style="color:#00ffaa;">‚úÖ Episode published!</span>';
                document.getElementById('episode-title').value = '';
                document.getElementById('episode-desc').value = '';
                fileInput.value = '';
                renderEpisodesList();
                // no need to call renderPublic here ‚Äì it's separate page
            } catch (err) {
                console.error(err);
                document.getElementById('upload-status').innerHTML = '<span style="color:#ff4d4d;">Upload failed. Check console.</span>';
            }
        }

        // ... (keep all other functions identical) ...
    </script>
</body>
</html>
