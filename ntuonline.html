<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ntudioka Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        /* (keep all your existing admin styles) */
    </style>
</head>
<body>
    <!-- (keep all existing admin HTML structure) -->
    <div id="admin-dashboard">...</div>

    <script>
        // ========== CONFIGURATION ==========
        const CLIENT_ID = '672649423935-e3g0m98jkikrp6p4e5iesd3mqs4tfpqi.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD91n0Uv-It5GUtfrXyNRXWs8o1eTWiHAo';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // ========== DATA ==========
        let data = { adminPassword: 'admin123', episodes: [] };
        function loadData() { /* same as before */ }
        function saveData() { localStorage.setItem('ntudiokaData', JSON.stringify(data)); }
        loadData();

        // ========== GOOGLE DRIVE ==========
        let accessToken = null;
        let tokenClient;

        function initGoogleDrive() { /* same as before */ }
        function authenticateDrive() { /* same as before */ }
        async function ensureAuthenticated() { /* same as before */ }

        // ✅ UPDATED UPLOAD – stores only fileId (no direct link)
        async function uploadFileToDrive(file) {
            await ensureAuthenticated();
            const metadata = {
                name: file.name,
                mimeType: file.type,
                parents: ['root']
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
                body: form
            });
            const fileData = await response.json();
            const fileId = fileData.id;

            // Make file public
            await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
                method: 'POST',
                headers: {
                    Authorization: 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ role: 'reader', type: 'anyone' })
            });

            return { fileId, fileName: file.name };
        }

        // ✅ UPDATED EPISODE CREATION – stores only fileId
        async function uploadEpisode() {
            const title = document.getElementById('episode-title').value.trim();
            const desc = document.getElementById('episode-desc').value.trim();
            const fileInput = document.getElementById('audio-file');
            const file = fileInput.files[0];
            if (!title || !desc || !file) {
                document.getElementById('upload-status').innerHTML = '<span style="color:#ff4d4d;">All fields required</span>';
                return;
            }
            document.getElementById('upload-status').innerHTML = '<span style="color:#00ffaa;">⏳ Uploading to Drive...</span>';

            try {
                const driveResult = await uploadFileToDrive(file);
                const newEpisode = {
                    id: Date.now(),
                    title,
                    desc,
                    date: new Date().toISOString().slice(0, 10),
                    driveFileId: driveResult.fileId,   // ✅ store only the ID
                    fileName: driveResult.fileName
                };
                data.episodes.push(newEpisode);
                saveData();
                document.getElementById('upload-status').innerHTML = '<span style="color:#00ffaa;">✅ Episode published!</span>';
                document.getElementById('episode-title').value = '';
                document.getElementById('episode-desc').value = '';
                fileInput.value = '';
                renderEpisodesList();
            } catch (err) {
                console.error(err);
                document.getElementById('upload-status').innerHTML = '<span style="color:#ff4d4d;">Upload failed. Check console.</span>';
            }
        }

        // (keep all other functions: login, renderEpisodesList, delete, changePassword, etc.)
        // ...
    </script>
</body>
</html>
