<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OBATA SMART SAVINGS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; }
    .container { max-width:1200px; margin:auto; padding:20px; }
    .card { background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,.08); }
    h1,h2,h3 { margin:0 0 10px; }
    input, select, button { padding:10px; width:100%; margin-top:8px; }
    button { background:#1e88e5; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#1565c0; }
    .danger { background:#c62828; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; }
    .hidden { display:none; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #ddd; text-align:left; }
  </style>
</head>
<body>
<div class="container">

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h1>OBATA SMART SAVINGS</h1>
  <input id="username" placeholder="Username" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
  <h1>Dashboard</h1>
  <p id="welcome"></p>
</div>

<div class="grid">
  <div class="card"><h3>Total Savings</h3><p id="totalSavings">NGN ₦0.00</p></div>
  <div class="card"><h3>Outstanding Loans</h3><p id="totalLoans">NGN ₦0.00</p></div>
  <div class="card"><h3>Today's Contributions</h3><p id="todayContrib">NGN ₦0.00</p></div>
</div>

<!-- MEMBER MANAGEMENT -->
<div class="card">
  <h2>Member Management</h2>
  <input id="mName" placeholder="Full Name" />
  <input id="mPhone" placeholder="Phone Number" />
  <button onclick="addMember()">Create Member</button>
</div>

<div class="card">
  <h3>Verify / Search Member</h3>
  <input id="vCustomerId" placeholder="Customer ID" />
  <input id="vPhone" placeholder="Phone" />
  <input id="vName" placeholder="Name" />
  <button onclick="verifyMember()">Search</button>
  <div id="verifyResult"></div>
</div>

<!-- CONTRIBUTION -->
<div class="card">
  <h2>Record Contribution</h2>
  <input id="cCustomer" placeholder="Customer ID" />
  <input id="cAmount" type="number" placeholder="Amount (NGN)" />
  <select id="cType"><option>DAILY</option><option>WEEKLY</option><option>MONTHLY</option></select>
  <button onclick="addContribution()">Post Contribution</button>
</div>

<!-- LOANS -->
<div class="card">
  <h2>Loan Management</h2>
  <input id="lCustomer" placeholder="Customer ID" />
  <input id="lAmount" type="number" placeholder="Loan Amount (NGN)" />
  <button onclick="disburseLoan()">Disburse Loan</button>
</div>

<!-- REPORTS -->
<div class="card">
  <h2>Reports</h2>
  <input id="rCustomer" placeholder="Customer ID for Statement" />
  <button onclick="printStatement()">Print Statement</button>
  <button onclick="dailyClosing()">Run Daily Closing (EOD)</button>
</div>

<button onclick="openPasswordChange()">Change Password</button>
<button class="danger" onclick="openWipe()">Wipe Database</button>
<button class="danger" onclick="logout()">Logout</button>
</div>

<!-- DATA WIPE -->
<div id="wipeCard" class="hidden">
  <div class="card">
    <h2>System Data Wipe</h2>
    <p><b>Warning:</b> This will permanently delete ALL system data.</p>
    <input id="wipeUser" placeholder="Username" />
    <input id="wipePass" type="password" placeholder="Password" />
    <button class="danger" onclick="wipeData()">Confirm Wipe</button>
    <button onclick="backToDashboard()">Cancel</button>
  </div>
</div>

<!-- PASSWORD CHANGE -->
<div id="pwdChange" class="hidden">
  <div class="card">
    <h2>Change Password</h2>
    <input id="newPwd" type="password" placeholder="New Password" />
    <input id="confirmPwd" type="password" placeholder="Confirm Password" />
    <button onclick="changePassword()">Update Password</button>
  </div>
</div>

<!-- MEMBER DETAILS -->
<div id="memberDetails" class="hidden">
  <div class="card">
    <h2>Member Created</h2>
    <p><b>ID:</b> <span id="dId"></span></p>
    <p><b>Name:</b> <span id="dName"></span></p>
    <p><b>Phone:</b> <span id="dPhone"></span></p>
    <p><b>Created:</b> <span id="dCreated"></span></p>
    <button onclick="backToDashboard()">Back</button>
  </div>
</div>

<!-- CONTRIBUTION CONFIRM -->
<div id="contribConfirm" class="hidden">
  <div class="card">
    <h2>Contribution Posted</h2>
    <p><b>Customer:</b> <span id="ccCust"></span></p>
    <p><b>Type:</b> <span id="ccType"></span></p>
    <p><b>Amount:</b> <span id="ccAmt"></span></p>
    <p><b>Date:</b> <span id="ccTime"></span></p>
    <button onclick="backToDashboard()">Back</button>
  </div>
</div>

<!-- LOAN CONFIRM -->
<div id="loanConfirm" class="hidden">
  <div class="card">
    <h2>Loan Disbursed</h2>
    <p><b>Customer:</b> <span id="lcCust"></span></p>
    <p><b>Amount:</b> <span id="lcAmt"></span></p>
    <p><b>Date:</b> <span id="lcTime"></span></p>
    <button onclick="backToDashboard()">Back</button>
  </div>
</div>

</div>

<script>
let currentUser=null;
let auth=JSON.parse(localStorage.getItem('auth'))||{username:'Administrator',password:'Admin123',forceChange:true};
let members=JSON.parse(localStorage.getItem('members'))||{};
let ledger=JSON.parse(localStorage.getItem('ledger'))||[];
let logs=JSON.parse(localStorage.getItem('logs'))||[];
let lastSerial=parseInt(localStorage.getItem('lastSerial'))||0;
let totals={savings:0,loans:0,today:0};

function recalcTotals(){
  totals={savings:0,loans:0,today:0};
  const today=new Date().toLocaleDateString();
  ledger.forEach(l=>{
    if(l.type==='DAILY'||l.type==='WEEKLY'||l.type==='MONTHLY'){
      totals.savings+=l.credit;
      if(l.time.includes(today)) totals.today+=l.credit;
    }
    if(l.type==='LOAN') totals.loans+=Math.abs(l.credit);
  });
}

function login() {
  const u=document.getElementById('username').value;
  const p=document.getElementById('password').value;
  if(u!==auth.username||p!==auth.password) return alert('Invalid credentials');
  currentUser=u;
  document.getElementById('loginCard').classList.add('hidden');
  if(auth.forceChange){ document.getElementById('pwdChange').classList.remove('hidden'); return; }
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('welcome').innerText=`Welcome, ${currentUser}`;
  recalcTotals();
}
function logout(){location.reload();}

function openPasswordChange(){
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('pwdChange').classList.remove('hidden');
}

function openWipe(){
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('wipeCard').classList.remove('hidden');
}

function changePassword(){
  const n=document.getElementById('newPwd').value;
  const c=document.getElementById('confirmPwd').value;
  if(!n||n.length<6) return alert('Password too short (min 6 chars)');
  if(n!==c) return alert('Passwords do not match');
  auth.password=n;
  auth.forceChange=false;
  localStorage.setItem('auth',JSON.stringify(auth));
  document.getElementById('newPwd').value='';
  document.getElementById('confirmPwd').value='';
  document.getElementById('pwdChange').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('welcome').innerText=`Welcome, ${currentUser}`;
  recalcTotals();
}

function wipeData(){
  const u=document.getElementById('wipeUser').value;
  const p=document.getElementById('wipePass').value;
  if(u!=='Superadministrator'||p!=='supro') return alert('Unauthorized');
  if(!confirm('This action cannot be undone. Continue?')) return;
  localStorage.clear();
  alert('System data wiped successfully');
  location.reload();
}

function log(action,cust,amt){
  logs.push({user:currentUser,action,cust,amt,time:new Date().toLocaleString()});
  localStorage.setItem('logs',JSON.stringify(logs));
}

function addMember(){
  const name=mName.value.trim(); const phone=mPhone.value.trim();
  if(!name) return alert('Name required');
  for(const id in members){ if(members[id].name.toLowerCase()==name.toLowerCase()&&members[id].phone==phone)
    return alert('Duplicate member. ID: '+id); }
  lastSerial++; const id=`OSS-${String(lastSerial).padStart(6,'0')}`;
  const created=new Date().toLocaleString();
  members[id]={name,phone,created};
  localStorage.setItem('members',JSON.stringify(members));
  localStorage.setItem('lastSerial',lastSerial);
  log('CREATE_MEMBER',id,0);
  dashboard.classList.add('hidden'); memberDetails.classList.remove('hidden');
  dId.innerText=id; dName.innerText=name; dPhone.innerText=phone||'-'; dCreated.innerText=created;
}

function verifyMember(){
  const cid=vCustomerId.value.trim(); const phone=vPhone.value.trim(); const name=vName.value.toLowerCase();
  let rows=[];
  for(const id in members){ const m=members[id];
    if((cid&&id==cid)||(phone&&m.phone==phone)||(name&&m.name.toLowerCase().includes(name))) rows.push({id,...m}); }
  if(!rows.length){verifyResult.innerHTML='No match';return;}
  let out='<table><tr><th>ID</th><th>Name</th><th>Phone</th><th>Created</th></tr>';
  rows.forEach(r=>out+=`<tr><td>${r.id}</td><td>${r.name}</td><td>${r.phone||'-'}</td><td>${r.created}</td></tr>`);
  verifyResult.innerHTML=out+='</table>';
}

function addContribution() {
  const cust = document.getElementById('cCustomer').value.trim();
  const amt = parseFloat(document.getElementById('cAmount').value);
  const type = document.getElementById('cType').value;

  if (!cust || !amt || amt <= 0) return alert('Enter valid contribution data');
  if (!members[cust]) return alert('Customer not found');

  const time = new Date().toLocaleString();
  const txn = { cust, type, credit: amt, time };
  ledger.push(txn);

  localStorage.setItem('ledger', JSON.stringify(ledger));

  recalcTotals();

  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('contribConfirm').classList.remove('hidden');

  document.getElementById('ccCust').innerText = cust;
  document.getElementById('ccType').innerText = type;
  document.getElementById('ccAmt').innerText = `NGN ₦${amt.toFixed(2)}`;
  document.getElementById('ccTime').innerText = time;

  document.getElementById('cCustomer').value = '';
  document.getElementById('cAmount').value = '';
}

function eligibleForLoan(cust){
  let saved=ledger.filter(l=>l.cust==cust&&(l.type==='DAILY'||l.type==='WEEKLY'||l.type==='MONTHLY'))
                  .reduce((s,l)=>s+l.credit,0);
  return saved>=50000;
}

function disburseLoan(){
  const cust = document.getElementById('lCustomer').value.trim();
  const amt = parseFloat(document.getElementById('lAmount').value);

  if(!cust || !amt || amt <= 0) return alert('Enter valid loan data');
  if(!members[cust]) return alert('Member not found');
  if(!eligibleForLoan(cust)) return alert('Not eligible for loan');

  const time = new Date().toLocaleString();
  ledger.push({ cust, type:'LOAN', credit:-amt, time });
  localStorage.setItem('ledger', JSON.stringify(ledger));
  log('LOAN_DISBURSE', cust, amt);

  recalcTotals();

  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('loanConfirm').classList.remove('hidden');

  document.getElementById('lcCust').innerText = cust;
  document.getElementById('lcAmt').innerText = `NGN ₦${amt.toFixed(2)}`;
  document.getElementById('lcTime').innerText = time;

  document.getElementById('lCustomer').value = '';
  document.getElementById('lAmount').value = '';
}

function printStatement(){
  const id=rCustomer.value; if(!members[id]) return alert('Not found');
  let w=window.open('','_blank');
  w.document.write(`<h1>OBATA SMART SAVINGS</h1><p>${id} - ${members[id].name}</p><hr>`);
  ledger.filter(l=>l.cust==id).forEach(l=>w.document.write(`<p>${l.time} | ${l.type} | NGN ₦${l.credit}</p>`));
  w.print();
}

function dailyClosing(){
  const today=new Date().toLocaleDateString();
  const total=ledger.filter(l=>l.time.includes(today)).reduce((s,l)=>s+l.credit,0);
  log('EOD','SYSTEM',total);
  alert(`EOD Completed. Total Today: NGN ₦${total}`);
}

function backToDashboard() {
  document.getElementById('memberDetails').classList.add('hidden');
  document.getElementById('contribConfirm').classList.add('hidden');
  document.getElementById('loanConfirm').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
}

function recalcTotals() {
  let savings = 0;
  let loans = 0;
  let today = 0;
  const todayStr = new Date().toLocaleDateString();

  ledger.forEach(l => {
    if (l.type === 'DAILY' || l.type === 'WEEKLY' || l.type === 'MONTHLY') {
      savings += l.credit;
      if (new Date(l.time).toLocaleDateString() === todayStr) {
        today += l.credit;
      }
    }
    if (l.type === 'LOAN') {
      loans += Math.abs(l.credit);
    }
  });

  document.getElementById('totalSavings').innerText = `NGN ₦${savings.toFixed(2)}`;
  document.getElementById('totalLoans').innerText = `NGN ₦${loans.toFixed(2)}`;
  document.getElementById('todayContrib').innerText = `NGN ₦${today.toFixed(2)}`;
}
</script>
</body>
</html>

